<html><head></head><body><p>当年，年少无知，被引入了Arch<del>邪</del>神教，在Y9000X 2022款下，为了解决Optimus的兼容问题，一路倒腾。</p><p>注意：本文章对应的机子为Y9000X 2022 i7+3060款，在外置硬盘上安装了ArchLinux，使用的是<a href="https://github.com/Askannz/optimus-manager">Optimus-manager</a>与<code>闭源nvidia驱动</code>。参考本教程操作系统时，若造成不良后果，本人概不负责。</p><h2 id="什么是Optimus-MUX？"><a href="https://xiue233.github.io/2023/11/01/linux-mux-resolution-for-legion/#%E4%BB%80%E4%B9%88%E6%98%AFOptimus-MUX%EF%BC%9F" class="headerlink" title="什么是Optimus/MUX？"></a>什么是Optimus/MUX？</h2><p><img src="https://xiue233.github.io/images/muxed-introduction.jpg" alt="muxed-introduction"/></p><p>Optimus/MUX Switch可以说是一种多显卡切换方案，具体细节不再追述，请自行查阅相关资料，简单来说分为：integrated(集显模式)、hybrid(混显模式)、discrete(独显模式)。</p><p>上述模式功能如名，是与接入显卡的方式有关的。可以看上图展示的三种模式，其中Y9000X很荣幸使用了第三种Very high-end <del>low</del>的模式，在混显模式下独显会通过核显输出(与图中描述有点差异)，在独显模式下，将会屏蔽核显，直接由独显输出。</p><p>此时问题就来了，即使linux上安装了Optimus支持的软件，也会因为切换模式时的显卡变化产生问题。</p><h2 id="为什么仅安装驱动与Optimus会不完全支持"><a href="https://xiue233.github.io/2023/11/01/linux-mux-resolution-for-legion/#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BB%85%E5%AE%89%E8%A3%85%E9%A9%B1%E5%8A%A8%E4%B8%8EOptimus%E4%BC%9A%E4%B8%8D%E5%AE%8C%E5%85%A8%E6%94%AF%E6%8C%81" class="headerlink" title="为什么仅安装驱动与Optimus会不完全支持"></a>为什么仅安装驱动与Optimus会不完全支持</h2><p>当安装了序言所提到的Optimus-manager与闭源nvidia驱动后，在混显模式及集显模式下可以正常工作，但是如果是以独显启动的话，便会卡在开机界面。</p><p>读取错误日志便可以发现问题的关键：</p><p><img src="https://xiue233.github.io/images/discrete-error-log.jpg" alt="discrete-error-log"/></p><p>从上图中可以得到一个关键信息：<code>PCIError: Cannot find the integrated GPU. Is this an Optimus System?</code></p><p>即，此Optimus并未适配独显模式，仅支持混显或者核显模式。如果在独显模式打开，Optimus会找不到核显，而报错，导致图形界面无法正常渲染。</p><h2 id="解决方案"><a href="https://xiue233.github.io/2023/11/01/linux-mux-resolution-for-legion/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="headerlink" title="解决方案"></a>解决方案</h2><p>作为一个定居在<del>Windows</del>SteamOS下的用户，开独显模式以提升帧率是必要的，但是，若是我再切换到Linux下工作，还要再次跳到混显模式，真的是操蛋。这能忍？于是就开启了与这个问题较劲的时间。</p><p>当时，我就在想，能不能有一个东西在开机加载模块的时候自动识别显卡情况，如果没核显的话自动切换到独显的正常支持上；如果有核显的话，就启动Optimus以支持mux方案。显然，这个东西超出了我的技术范畴，还真不会写，时间暂时告一段落，<del>气得我要掉小珍珠了</del>。</p><p>偶然在Optimus-manager的issue下发现有人也是拯救者笔记本遇到了这个问题，他下载了一个叫做System76-power的东西来解决。等等？这是什么？</p><h3 id="System76-power——解决独显模式与Optimus适配的关键稻草"><a href="https://xiue233.github.io/2023/11/01/linux-mux-resolution-for-legion/#System76-power%E2%80%94%E2%80%94%E8%A7%A3%E5%86%B3%E7%8B%AC%E6%98%BE%E6%A8%A1%E5%BC%8F%E4%B8%8EOptimus%E9%80%82%E9%85%8D%E7%9A%84%E5%85%B3%E9%94%AE%E7%A8%BB%E8%8D%89" class="headerlink" title="System76-power——解决独显模式与Optimus适配的关键稻草"></a>System76-power——解决独显模式与Optimus适配的关键稻草</h3><blockquote><p><a href="https://github.com/pop-os/system76-power">System76-power</a> is a utility for managing graphics and power profiles.</p></blockquote><p>System76-power真的是梦中工具，完美实现了我当时设想的解决方案(不如说人家做得比我想的好多了)，它会在启动的时候自动检测显卡的连接情况，自动选择Optimus方案和独显直连模式，并且完美兼容安装的Optimus-manager。</p><p>但是，又出现了一些小问题。</p><h3 id="独显模式下无法调节笔记本亮度及独显输出接口无输出"><a href="https://xiue233.github.io/2023/11/01/linux-mux-resolution-for-legion/#%E7%8B%AC%E6%98%BE%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%97%A0%E6%B3%95%E8%B0%83%E8%8A%82%E7%AC%94%E8%AE%B0%E6%9C%AC%E4%BA%AE%E5%BA%A6%E5%8F%8A%E7%8B%AC%E6%98%BE%E8%BE%93%E5%87%BA%E6%8E%A5%E5%8F%A3%E6%97%A0%E8%BE%93%E5%87%BA" class="headerlink" title="独显模式下无法调节笔记本亮度及独显输出接口无输出"></a>独显模式下无法调节笔记本亮度及独显输出接口无输出</h3><p>在激动人心的启动后，不出意外就出意外了，笔记本的屏幕快把我的钛合金眼亮瞎了，并且调节亮度的ui很卡，实际上也无法调节亮度，并且我的外接显示器无信号输入了(接在全能type c口，且据检测hdmi口也无输出)，在xrandr中仅显示内置屏幕。</p><p>emm,此处，应该是nvidia驱动的加载问题吧？查资料找到一个解决方法就是，在/usr/share/X11/xorg.conf.d下创建一个10-nvidia.conf文件，内容如下:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><code class="hljs conf">Section &#34;Device&#34;<br/>    Identifier &#34;Device0&#34;<br/>    Driver &#34;nvidia&#34;<br/>    VendorName &#34;NVIDIA Corporation&#34;<br/>    Option &#34;RegistryDwords&#34; &#34;EnableBrightnessControl=1&#34;<br/>    Option &#34;NoLogo&#34; &#34;True&#34;<br/>EndSection<br/></code></pre></td></tr></tbody></table></figure><p>之后reboot下，便可解决调节亮度的问题和无输出的问题，缺点是：在仅核显模式下，因为强制启用了nvidia驱动，找不到nvidia又无法启动了，当然这个问题我暂未解决，至少optimus和独显模式能用了，optimus下也差不多省电吧。</p><h2 id="尾语"><a href="https://xiue233.github.io/2023/11/01/linux-mux-resolution-for-legion/#%E5%B0%BE%E8%AF%AD" class="headerlink" title="尾语"></a>尾语</h2><p>大声告诉我那几个字：</p><p><code>Arch,Yes!</code></p><p>在ArchLinux的折腾下，确实了解了诸多好玩的东西。</p></body></html>