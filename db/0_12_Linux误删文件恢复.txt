<html><head></head><body><blockquote><p>删了私有云上几百个文件，不过好在最后发现只是删除了数据库里边的记录。万幸万幸。</p></blockquote><p>注意，<strong>下面的操作只适用于删文件的进程已经挂了的情况，请根据自己情况选择合适的方法</strong>。</p><h2 id="首先要做的"><a href="https://xeonds.github.io/2023/08/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/linux-undelete/#%E9%A6%96%E5%85%88%E8%A6%81%E5%81%9A%E7%9A%84" class="headerlink" title="首先要做的"></a>首先要做的</h2><p>赶紧杀掉所有进程，防止数据写入到磁盘覆盖<code>inode</code>，如果被覆盖基本就凉了。比如说，停止当前分区的服务，赶紧卸载当前分区设备，甚至直接断网都是有必要的。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">unmount /dev/sda1</span><br/><span class="line"><span class="comment"># 如果设备忙的话，用下面的命令强制卸载</span></span><br/><span class="line">fuser -m -v -i -k /dir</span><br/></pre></td></tr></tbody></table></figure><p>然后用<code>dd</code>备份分区，防止恢复失败。比如可以用下面的指令：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/sda1 of=/tmp/sda1.img</span><br/></pre></td></tr></tbody></table></figure><h2 id="工具准备"><a href="https://xeonds.github.io/2023/08/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/linux-undelete/#%E5%B7%A5%E5%85%B7%E5%87%86%E5%A4%87" class="headerlink" title="工具准备"></a>工具准备</h2><p>根据分区类型使用<code>extundelete</code>或者<code>ntfsundelete</code>。后者直接安装<code>ntfs-3g</code>即可，前者使用apt安装<code>extundelete</code>。</p><h2 id="恢复"><a href="https://xeonds.github.io/2023/08/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/linux-undelete/#%E6%81%A2%E5%A4%8D" class="headerlink" title="恢复"></a>恢复</h2><p><a href="https://manpages.ubuntu.com/manpages/focal/en/man8/ntfsundelete.8.html">官方文档</a></p><p>如果是ntfs分区的话，用这个命令得到文件列表：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这个-f是因为我懒得卸载卷了</span></span><br/><span class="line"><span class="comment"># 正常情况下还是先unmount了再操作，比较安全</span></span><br/><span class="line"><span class="comment"># 这样就不用加-f了</span></span><br/><span class="line">sudo ntfsundelete -s /dev/sdc2 -f &gt; rec-list.txt</span><br/><span class="line"></span><br/><span class="line"><span class="comment"># 或者还有下面这些指令</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment"># Look for deleted files on /dev/hda1.</span></span><br/><span class="line">ntfsundelete /dev/hda1</span><br/><span class="line"></span><br/><span class="line"><span class="comment"># Look for deleted documents on /dev/hda1.</span></span><br/><span class="line">ntfsundelete /dev/hda1 -s -m <span class="string">&#39;*.doc&#39;</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment"># Look for deleted files between 5000 and 6000000 bytes, with  at  least  90%  of  the  data</span></span><br/><span class="line"><span class="comment"># recoverable, on /dev/hda1.</span></span><br/><span class="line">ntfsundelete /dev/hda1 -S 5k-6m -p 90</span><br/><span class="line"></span><br/><span class="line"><span class="comment"># Look for deleted files altered in the last two days</span></span><br/><span class="line">ntfsundelete /dev/hda1 -t 2d</span><br/><span class="line"></span><br/></pre></td></tr></tbody></table></figure><p>然后可以按删除日期来筛查文件：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> rec-list.txt | grep 2023-08-30 &gt; res-filtered.txt</span><br/></pre></td></tr></tbody></table></figure><p>最后恢复文件：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment"># Undelete inodes 2, 5 and 100 to 131 of device /dev/sda1</span></span><br/><span class="line">ntfsundelete /dev/sda1 -u -i 2,5,100-131</span><br/><span class="line"></span><br/><span class="line"><span class="comment"># Undelete  inode number 3689, call the file &#39;work.doc&#39;, set it to recovered size and put it</span></span><br/><span class="line"><span class="comment"># in the user&#39;s home directory.</span></span><br/><span class="line">ntfsundelete /dev/hda1 -u -T -i 3689 -o work.doc -d ~</span><br/><span class="line"></span><br/><span class="line"><span class="comment"># Save MFT Records 3689 to 3690 to a file &#39;debug&#39;</span></span><br/><span class="line">ntfsundelete /dev/hda1 -c 3689-3690 -o debug</span><br/></pre></td></tr></tbody></table></figure></body></html>